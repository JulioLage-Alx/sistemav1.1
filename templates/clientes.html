<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes - {{ config.nome_empresa }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="nav-container">
            <a href="{{ url_for('dashboard') }}" class="logo">
                <span>ü•©</span>
                {{ config.nome_empresa }}
            </a>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="nav-item"><a href="{{ url_for('clientes') }}" class="active">Clientes</a></li>
                    <li class="nav-item"><a href="{{ url_for('vendas') }}">Vendas</a></li>
                    <li class="nav-item"><a href="{{ url_for('pagamentos') }}">Pagamentos</a></li>
                    <li class="nav-item"><a href="{{ url_for('relatorios') }}">Relat√≥rios</a></li>
                    <li class="nav-item"><a href="{{ url_for('logout') }}" class="logout">Sair</a></li>
                </ul>
            </nav>
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
        </div>
    </header>

    <!-- Container Principal -->
    <div class="main-container">
        <!-- Cabe√ßalho da P√°gina -->
        <div class="page-header">
            <div>
                <h1>üë• Gest√£o de Clientes</h1>
                <p class="page-subtitle">Gerencie todos os seus clientes em um s√≥ lugar</p>
            </div>
            <div class="page-actions">
                <button class="btn btn-secondary" onclick="exportarClientes()">
                    <span>üìä</span> Exportar
                </button>
                <button class="btn btn-primary" onclick="abrirModalNovoCliente()">
                    <span>‚ûï</span> Novo Cliente
                </button>
            </div>
        </div>

        <!-- M√©tricas R√°pidas -->
        <div class="metrics-summary">
            <div class="metric-card">
                <div class="metric-icon">üë•</div>
                <div class="metric-content">
                    <div class="metric-number" id="totalClientes">0</div>
                    <div class="metric-label">Total de Clientes</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">üí∞</div>
                <div class="metric-content">
                    <div class="metric-number" id="valorEmAberto">R$ 0,00</div>
                    <div class="metric-label">Valor em Aberto</div>
                </div>
            </div>
            <div class="metric-card warning">
                <div class="metric-icon">‚ö†Ô∏è</div>
                <div class="metric-content">
                    <div class="metric-number" id="clientesLimite">0</div>
                    <div class="metric-label">Pr√≥ximos do Limite</div>
                </div>
            </div>
            <div class="metric-card success">
                <div class="metric-icon">‚úÖ</div>
                <div class="metric-content">
                    <div class="metric-number" id="clientesOk">0</div>
                    <div class="metric-label">Clientes OK</div>
                </div>
            </div>
        </div>

        <!-- Filtros e Busca -->
        <div class="filters-section">
            <div class="filters-header">
                <h3>üîç Filtros e Busca</h3>
                <button class="btn btn-secondary btn-small" onclick="limparFiltros()">Limpar Filtros</button>
            </div>
            
            <div class="search-bar">
                <input type="text" id="filtroClientes" placeholder="Buscar por nome, CPF ou telefone..." 
                       onkeyup="filtrarClientes()" class="search-input">
                <button onclick="filtrarClientes()" class="search-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>
                </button>
            </div>

            <div class="filter-options">
                <div class="filter-group">
                    <label>Status:</label>
                    <select id="filtroTipo" onchange="filtrarClientes()">
                        <option value="">Todos os clientes</option>
                        <option value="com_saldo">Com saldo devedor</option>
                        <option value="limite_proximo">Pr√≥ximo do limite</option>
                        <option value="inadimplente">Inadimplentes</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Ordenar por:</label>
                    <select id="filtroOrdem" onchange="filtrarClientes()">
                        <option value="nome">Nome A-Z</option>
                        <option value="saldo_desc">Maior Saldo Devedor</option>
                        <option value="cadastro_desc">Mais Recentes</option>
                        <option value="limite_desc">Maior Limite</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Limite m√≠nimo:</label>
                    <select id="filtroLimite" onchange="filtrarClientes()">
                        <option value="">Qualquer limite</option>
                        <option value="500">Acima de R$ 500</option>
                        <option value="1000">Acima de R$ 1.000</option>
                        <option value="2000">Acima de R$ 2.000</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Lista de Clientes -->
        <div class="content-section">
            <div id="listaClientes" class="clientes-grid">
                <!-- Carregado via JavaScript -->
            </div>

            <div id="loadingClientes" class="loading-section" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Carregando clientes...</p>
            </div>

            <div id="nenhumCliente" class="empty-state" style="display: none;">
                <div class="empty-icon">üë•</div>
                <h3>Nenhum cliente encontrado</h3>
                <p>Cadastre o primeiro cliente ou refine sua busca.</p>
                <button class="btn btn-primary" onclick="abrirModalNovoCliente()">
                    <span>‚ûï</span> Cadastrar Cliente
                </button>
            </div>
        </div>

        <!-- Pagina√ß√£o -->
        <div class="pagination-section" id="paginacaoClientes" style="display: none;">
            <button id="btnAnterior" onclick="paginaAnterior()" class="btn btn-secondary">‚Üê Anterior</button>
            <div class="pagination-info">
                <span id="infoPaginacao">P√°gina 1 de 1</span>
                <span class="pagination-details">Mostrando <span id="resultadosInfo">0</span> resultados</span>
            </div>
            <button id="btnProximo" onclick="proximaPagina()" class="btn btn-secondary">Pr√≥ximo ‚Üí</button>
        </div>
    </div>

    <!-- Modal Novo/Editar Cliente -->
    <div id="modalCliente" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="tituloModalCliente">
                    <span class="modal-icon">üë§</span>
                    Novo Cliente
                </h3>
                <button class="modal-close" onclick="fecharModalCliente()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formCliente">
                    <input type="hidden" id="clienteId" name="id">
                    
                    <div class="form-section">
                        <h4 class="form-section-title">üìã Informa√ß√µes B√°sicas</h4>
                        
                        <div class="form-row">
                            <div class="form-group flex-2">
                                <label>Nome Completo *:</label>
                                <input type="text" id="clienteNome" name="nome" required placeholder="Digite o nome completo">
                            </div>
                            <div class="form-group">
                                <label>CPF:</label>
                                <input type="text" id="clienteCpf" name="cpf" placeholder="000.000.000-00" data-mask="cpf">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Telefone *:</label>
                                <input type="text" id="clienteTelefone" name="telefone" required 
                                       placeholder="(00) 00000-0000" data-mask="telefone">
                            </div>
                            <div class="form-group">
                                <label>E-mail:</label>
                                <input type="email" id="clienteEmail" name="email" placeholder="email@exemplo.com">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4 class="form-section-title">üí≥ Limite de Cr√©dito</h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Limite de Cr√©dito:</label>
                                <div class="input-group">
                                    <span class="input-prefix">R$</span>
                                    <input type="number" id="clienteLimite" name="limite_credito" 
                                           step="0.01" value="500.00" min="0">
                                </div>
                                <div class="field-help">
                                    <small>Valor m√°ximo que o cliente pode dever</small>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Status do Cliente:</label>
                                <select id="clienteStatus" name="status">
                                    <option value="ativo">‚úÖ Ativo</option>
                                    <option value="inativo">‚ùå Inativo</option>
                                    <option value="bloqueado">üö´ Bloqueado</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4 class="form-section-title">üìç Endere√ßo e Observa√ß√µes</h4>
                        
                        <div class="form-group">
                            <label>Endere√ßo Completo:</label>
                            <textarea id="clienteEndereco" name="endereco" rows="2" 
                                      placeholder="Rua, n√∫mero, bairro, cidade - CEP"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Observa√ß√µes:</label>
                            <textarea id="clienteObservacoes" name="observacoes" rows="3" 
                                      placeholder="Observa√ß√µes importantes sobre o cliente..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="fecharModalCliente()" class="btn btn-secondary">
                    <span>‚ùå</span> Cancelar
                </button>
                <button type="button" onclick="salvarCliente()" class="btn btn-primary">
                    <span id="btnSalvarTexto">üíæ Salvar Cliente</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Perfil do Cliente -->
    <div id="modalPerfilCliente" class="modal">
        <div class="modal-content modal-extra-large">
            <div class="modal-header">
                <h3 id="tituloPerfilCliente">
                    <span class="modal-icon">üë§</span>
                    Perfil do Cliente
                </h3>
                <button class="modal-close" onclick="fecharModalPerfil()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="perfil-cliente">
                    <!-- Dados do Cliente -->
                    <div class="perfil-section">
                        <div class="section-header">
                            <h4>üìã Dados do Cliente</h4>
                            <div class="section-actions">
                                <button class="btn btn-secondary btn-small" onclick="editarClientePerfil()">
                                    <span>‚úèÔ∏è</span> Editar
                                </button>
                                <button class="btn btn-danger btn-small" onclick="excluirClientePerfil()">
                                    <span>üóëÔ∏è</span> Excluir
                                </button>
                            </div>
                        </div>
                        <div class="perfil-info" id="dadosCliente">
                            <!-- Carregado via JavaScript -->
                        </div>
                    </div>

                    <!-- Estat√≠sticas -->
                    <div class="perfil-section">
                        <div class="section-header">
                            <h4>üìä Estat√≠sticas</h4>
                            <div class="section-actions">
                                <button class="btn btn-info btn-small" onclick="exportarHistoricoCliente()">
                                    <span>üìä</span> Exportar
                                </button>
                            </div>
                        </div>
                        <div class="stats-grid" id="estatisticasCliente">
                            <!-- Carregado via JavaScript -->
                        </div>
                    </div>

                    <!-- Hist√≥rico de Vendas -->
                    <div class="perfil-section">
                        <div class="section-header">
                            <h4>üõí Hist√≥rico de Vendas</h4>
                            <div class="section-actions">
                                <button class="btn btn-primary btn-small" onclick="novaVendaCliente()">
                                    <span>‚ûï</span> Nova Venda
                                </button>
                                <button class="btn btn-success btn-small" onclick="processarPagamentoCliente()">
                                    <span>üí∞</span> Processar Pagamento
                                </button>
                            </div>
                        </div>
                        <div class="vendas-lista" id="historicoVendas">
                            <!-- Carregado via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirma√ß√£o Exclus√£o -->
    <div id="modalConfirmacao" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h3>
                    <span class="modal-icon">‚ö†Ô∏è</span>
                    Confirmar Exclus√£o
                </h3>
                <button class="modal-close" onclick="fecharModalConfirmacao()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="confirmation-content">
                    <div class="confirmation-icon">‚ö†Ô∏è</div>
                    <p id="textoConfirmacao">Tem certeza que deseja excluir este cliente?</p>
                    <div class="warning-box">
                        <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Esta a√ß√£o n√£o pode ser desfeita e todos os dados relacionados ser√£o perdidos.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="fecharModalConfirmacao()" class="btn btn-secondary">
                    <span>‚ùå</span> Cancelar
                </button>
                <button type="button" onclick="confirmarExclusao()" class="btn btn-danger">
                    <span>üóëÔ∏è</span> Excluir
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Carregando...</div>
    </div>

    <!-- JavaScript -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        let clientes = [];
        let clientesFiltrados = [];
        let paginaAtual = 1;
        let itensPorPagina = 12;
        let clienteParaExcluir = null;
        let clienteAtual = null;

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            carregarClientes();
            configurarMascaras();
            animarEntrada();
        });

        function animarEntrada() {
            const elements = document.querySelectorAll('.metric-card');
            elements.forEach((el, index) => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    el.style.transition = 'all 0.6s ease';
                    el.style.opacity = '1';
                    el.style.transform = 'translateY(0)';
                }, index * 100);
            });
        }

        // Carregar lista de clientes
        function carregarClientes() {
            mostrarLoadingClientes();
            
            fetch('/api/clientes')
                .then(response => response.json())
                .then(data => {
                    esconderLoadingClientes();
                    
                    if (data.sucesso) {
                        clientes = data.clientes;
                        clientesFiltrados = [...clientes];
                        renderizarClientes();
                        atualizarMetricas();
                    } else {
                        mostrarNotificacao(data.erro || 'Erro ao carregar clientes', 'error');
                        mostrarEstadoVazio();
                    }
                })
                .catch(error => {
                    esconderLoadingClientes();
                    console.error('Erro:', error);
                    mostrarNotificacao('Erro ao carregar clientes', 'error');
                    mostrarEstadoVazio();
                });
        }

        function atualizarMetricas() {
            const totalClientes = clientes.length;
            const valorEmAberto = clientes.reduce((sum, c) => sum + c.saldo_devedor, 0);
            const clientesLimite = clientes.filter(c => c.saldo_devedor > c.limite_credito * 0.8).length;
            const clientesOk = clientes.filter(c => c.saldo_devedor === 0).length;

            document.getElementById('totalClientes').textContent = totalClientes;
            document.getElementById('valorEmAberto').textContent = formatar_moeda(valorEmAberto);
            document.getElementById('clientesLimite').textContent = clientesLimite;
            document.getElementById('clientesOk').textContent = clientesOk;
        }

        // Renderizar lista de clientes
        function renderizarClientes() {
            const container = document.getElementById('listaClientes');
            
            if (clientesFiltrados.length === 0) {
                mostrarEstadoVazio();
                return;
            }

            // Calcular pagina√ß√£o
            const totalPaginas = Math.ceil(clientesFiltrados.length / itensPorPagina);
            const inicio = (paginaAtual - 1) * itensPorPagina;
            const fim = inicio + itensPorPagina;
            const clientesPagina = clientesFiltrados.slice(inicio, fim);

            // Gerar HTML dos clientes
            const html = clientesPagina.map(cliente => `
                <div class="cliente-card" onclick="abrirPerfilCliente(${cliente.id})">
                    <div class="cliente-header">
                        <div class="cliente-info-principal">
                            <h3 class="cliente-nome">${cliente.nome}</h3>
                            <div class="cliente-contato">
                                <span class="cliente-telefone">üìû ${cliente.telefone}</span>
                                ${cliente.email ? `<span class="cliente-email">‚úâÔ∏è ${cliente.email}</span>` : ''}
                            </div>
                        </div>
                        <div class="cliente-status ${getStatusClasse(cliente)}">
                            <span class="status-indicator"></span>
                            ${getStatusTexto(cliente)}
                        </div>
                    </div>
                    
                    <div class="cliente-detalhes">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">CPF:</span>
                                <span class="info-value">${cliente.cpf_formatado || 'N√£o informado'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Limite:</span>
                                <span class="info-value">${cliente.limite_credito_formatado}</span>
                            </div>
                            <div class="info-item ${cliente.saldo_devedor > 0 ? 'destaque' : ''}">
                                <span class="info-label">Saldo Devedor:</span>
                                <span class="info-value saldo-${cliente.saldo_devedor > 0 ? 'positivo' : 'zero'}">
                                    ${cliente.saldo_devedor_formatado}
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Dispon√≠vel:</span>
                                <span class="info-value">${formatar_moeda(cliente.limite_credito - cliente.saldo_devedor)}</span>
                            </div>
                        </div>
                    </div>
                    
                    ${cliente.saldo_devedor > 0 ? `
                        <div class="cliente-progress">
                            <div class="progress-info">
                                <span class="progress-label">Utiliza√ß√£o do limite</span>
                                <span class="progress-percent">${cliente.percentual_limite_usado.toFixed(1)}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill ${getProgressClass(cliente.percentual_limite_usado)}" 
                                     style="width: ${Math.min(cliente.percentual_limite_usado, 100)}%"></div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="cliente-actions">
                        <button class="btn-action primary" onclick="event.stopPropagation(); editarCliente(${cliente.id})" 
                                title="Editar cliente">
                            <span>‚úèÔ∏è</span>
                        </button>
                        <button class="btn-action success" onclick="event.stopPropagation(); novaVendaCliente(${cliente.id})" 
                                title="Nova venda">
                            <span>üõí</span>
                        </button>
                        <button class="btn-action info" onclick="event.stopPropagation(); processarPagamentoCliente(${cliente.id})" 
                                title="Processar pagamento">
                            <span>üí∞</span>
                        </button>
                        <button class="btn-action secondary" onclick="event.stopPropagation(); abrirPerfilCliente(${cliente.id})" 
                                title="Ver perfil completo">
                            <span>üëÅÔ∏è</span>
                        </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
            
            // Atualizar pagina√ß√£o
            atualizarPaginacao(totalPaginas);
            
            // Esconder estado vazio
            document.getElementById('nenhumCliente').style.display = 'none';

            // Animar cards
            setTimeout(() => {
                document.querySelectorAll('.cliente-card').forEach((card, index) => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        card.style.transition = 'all 0.4s ease';
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, index * 50);
                });
            }, 100);
        }

        // Fun√ß√µes auxiliares para status do cliente
        function getStatusClasse(cliente) {
            if (cliente.saldo_devedor > cliente.limite_credito) return 'inadimplente';
            if (cliente.saldo_devedor > cliente.limite_credito * 0.8) return 'limite-alto';
            if (cliente.saldo_devedor > 0) return 'com-saldo';
            return 'ok';
        }

        function getStatusTexto(cliente) {
            if (cliente.saldo_devedor > cliente.limite_credito) return 'Inadimplente';
            if (cliente.saldo_devedor > cliente.limite_credito * 0.8) return 'Limite Alto';
            if (cliente.saldo_devedor > 0) return 'Com Saldo';
            return 'Em Dia';
        }

        function getProgressClass(percentual) {
            if (percentual > 100) return 'danger';
            if (percentual > 80) return 'warning';
            return 'success';
        }

        // Filtrar clientes
        function filtrarClientes() {
            const filtroTexto = document.getElementById('filtroClientes').value.toLowerCase();
            const filtroTipo = document.getElementById('filtroTipo').value;
            const filtroOrdem = document.getElementById('filtroOrdem').value;
            const filtroLimite = document.getElementById('filtroLimite').value;

            // Aplicar filtros
            clientesFiltrados = clientes.filter(cliente => {
                // Filtro por texto
                const matchTexto = !filtroTexto || 
                    cliente.nome.toLowerCase().includes(filtroTexto) ||
                    (cliente.cpf && cliente.cpf.includes(filtroTexto)) ||
                    cliente.telefone.includes(filtroTexto) ||
                    (cliente.email && cliente.email.toLowerCase().includes(filtroTexto));

                if (!matchTexto) return false;

                // Filtro por tipo
                switch(filtroTipo) {
                    case 'com_saldo':
                        if (cliente.saldo_devedor <= 0) return false;
                        break;
                    case 'limite_proximo':
                        if (cliente.saldo_devedor <= cliente.limite_credito * 0.8) return false;
                        break;
                    case 'inadimplente':
                        if (cliente.saldo_devedor <= cliente.limite_credito) return false;
                        break;
                }

                // Filtro por limite
                if (filtroLimite && cliente.limite_credito < parseFloat(filtroLimite)) {
                    return false;
                }

                return true;
            });

            // Aplicar ordena√ß√£o
            switch(filtroOrdem) {
                case 'saldo_desc':
                    clientesFiltrados.sort((a, b) => b.saldo_devedor - a.saldo_devedor);
                    break;
                case 'cadastro_desc':
                    clientesFiltrados.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    break;
                case 'limite_desc':
                    clientesFiltrados.sort((a, b) => b.limite_credito - a.limite_credito);
                    break;
                default: // nome
                    clientesFiltrados.sort((a, b) => a.nome.localeCompare(b.nome));
                    break;
            }

            // Resetar pagina√ß√£o e renderizar
            paginaAtual = 1;
            renderizarClientes();
        }

        function limparFiltros() {
            document.getElementById('filtroClientes').value = '';
            document.getElementById('filtroTipo').value = '';
            document.getElementById('filtroOrdem').value = 'nome';
            document.getElementById('filtroLimite').value = '';
            
            clientesFiltrados = [...clientes];
            paginaAtual = 1;
            renderizarClientes();
        }

        // Abrir modal novo cliente
        function abrirModalNovoCliente() {
            document.getElementById('tituloModalCliente').innerHTML = '<span class="modal-icon">‚ûï</span> Novo Cliente';
            document.getElementById('btnSalvarTexto').innerHTML = '<span>üíæ</span> Salvar Cliente';
            document.getElementById('formCliente').reset();
            document.getElementById('clienteId').value = '';
            document.getElementById('clienteLimite').value = '500.00';
            document.getElementById('clienteStatus').value = 'ativo';
            abrirModal('modalCliente');
        }

        // Editar cliente
        function editarCliente(clienteId) {
            mostrarLoading('Carregando dados do cliente...');
            
            fetch(`/api/clientes/${clienteId}`)
                .then(response => response.json())
                .then(data => {
                    esconderLoading();
                    
                    if (data.sucesso) {
                        const cliente = data.cliente;
                        
                        document.getElementById('tituloModalCliente').innerHTML = '<span class="modal-icon">‚úèÔ∏è</span> Editar Cliente';
                        document.getElementById('btnSalvarTexto').innerHTML = '<span>üíæ</span> Atualizar Cliente';
                        
                        document.getElementById('clienteId').value = cliente.id;
                        document.getElementById('clienteNome').value = cliente.nome;
                        document.getElementById('clienteCpf').value = cliente.cpf || '';
                        document.getElementById('clienteTelefone').value = cliente.telefone;
                        document.getElementById('clienteEmail').value = cliente.email || '';
                        document.getElementById('clienteLimite').value = cliente.limite_credito;
                        document.getElementById('clienteEndereco').value = cliente.endereco || '';
                        document.getElementById('clienteObservacoes').value = cliente.observacoes || '';
                        document.getElementById('clienteStatus').value = cliente.status || 'ativo';
                        
                        abrirModal('modalCliente');
                    } else {
                        mostrarNotificacao(data.erro || 'Erro ao carregar cliente', 'error');
                    }
                })
                .catch(error => {
                    esconderLoading();
                    console.error('Erro:', error);
                    mostrarNotificacao('Erro ao carregar cliente', 'error');
                });
        }

        // Salvar cliente
        function salvarCliente() {
            const form = document.getElementById('formCliente');
            const formData = new FormData(form);
            const dados = Object.fromEntries(formData);
            
            // Valida√ß√µes
            if (!dados.nome.trim()) {
                mostrarNotificacao('Nome √© obrigat√≥rio', 'error');
                return;
            }
            
            if (!dados.telefone.trim()) {
                mostrarNotificacao('Telefone √© obrigat√≥rio', 'error');
                return;
            }

            const clienteId = dados.id;
            const isEdicao = clienteId && clienteId !== '';
            
            const url = isEdicao ? `/api/clientes/${clienteId}` : '/api/clientes';
            const method = isEdicao ? 'PUT' : 'POST';
            
            // Remover ID dos dados se for cria√ß√£o
            if (!isEdicao) {
                delete dados.id;
            }

            mostrarLoading(isEdicao ? 'Atualizando cliente...' : 'Salvando cliente...');

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dados)
            })
            .then(response => response.json())
            .then(data => {
                esconderLoading();
                
                if (data.sucesso) {
                    mostrarNotificacao(data.mensagem || 'Cliente salvo com sucesso!', 'success');
                    fecharModalCliente();
                    carregarClientes();
                } else {
                    if (data.erros && Array.isArray(data.erros)) {
                        data.erros.forEach(erro => mostrarNotificacao(erro, 'error'));
                    } else {
                        mostrarNotificacao(data.erro || 'Erro ao salvar cliente', 'error');
                    }
                }
            })
            .catch(error => {
                esconderLoading();
                console.error('Erro:', error);
                mostrarNotificacao('Erro ao salvar cliente', 'error');
            });
        }

        // Configurar m√°scaras de input
        function configurarMascaras() {
            // M√°scara de CPF
            const cpfInput = document.getElementById('clienteCpf');
            cpfInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                e.target.value = value;
            });
            
            // M√°scara de telefone
            const telefoneInput = document.getElementById('clienteTelefone');
            telefoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 11) {
                    value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                } else if (value.length >= 10) {
                    value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                } else if (value.length >= 6) {
                    value = value.replace(/(\d{2})(\d{4})(\d)/, '($1) $2-$3');
                } else if (value.length >= 2) {
                    value = value.replace(/(\d{2})(\d)/, '($1) $2');
                }
                e.target.value = value;
            });
        }

        // [Continua com as fun√ß√µes restantes do JavaScript original...]
        // As demais fun√ß√µes permanecem iguais, apenas incluo algumas das principais aqui:

        function abrirPerfilCliente(clienteId) {
            mostrarLoading('Carregando perfil do cliente...');
            
            fetch(`/api/clientes/${clienteId}`)
                .then(response => response.json())
                .then(data => {
                    esconderLoading();
                    
                    if (data.sucesso) {
                        clienteAtual = data.cliente;
                        renderizarPerfilCliente(data);
                        abrirModal('modalPerfilCliente');
                    } else {
                        mostrarNotificacao(data.erro || 'Erro ao carregar perfil', 'error');
                    }
                })
                .catch(error => {
                    esconderLoading();
                    console.error('Erro:', error);
                    mostrarNotificacao('Erro ao carregar perfil', 'error');
                });
        }

        function renderizarPerfilCliente(data) {
            const cliente = data.cliente;
            const stats = data.estatisticas;
            
            // T√≠tulo
            document.getElementById('tituloPerfilCliente').innerHTML = `
                <span class="modal-icon">üë§</span>
                Perfil - ${cliente.nome}
            `;
            
            // Dados do cliente
            document.getElementById('dadosCliente').innerHTML = `
                <div class="perfil-dados-grid">
                    <div class="dado-item">
                        <div class="dado-label">Nome Completo</div>
                        <div class="dado-valor">${cliente.nome}</div>
                    </div>
                    <div class="dado-item">
                        <div class="dado-label">CPF</div>
                        <div class="dado-valor">${cliente.cpf_formatado || 'N√£o informado'}</div>
                    </div>
                    <div class="dado-item">
                        <div class="dado-label">Telefone</div>
                        <div class="dado-valor">${cliente.telefone}</div>
                    </div>
                    <div class="dado-item">
                        <div class="dado-label">E-mail</div>
                        <div class="dado-valor">${cliente.email || 'N√£o informado'}</div>
                    </div>
                    <div class="dado-item">
                        <div class="dado-label">Limite de Cr√©dito</div>
                        <div class="dado-valor destaque">${cliente.limite_credito_formatado}</div>
                    </div>
                    <div class="dado-item">
                        <div class="dado-label">Saldo Devedor</div>
                        <div class="dado-valor ${cliente.saldo_devedor > 0 ? 'negativo' : 'positivo'}">
                            ${cliente.saldo_devedor_formatado}
                        </div>
                    </div>
                    <div class="dado-item full-width">
                        <div class="dado-label">Endere√ßo</div>
                        <div class="dado-valor">${cliente.endereco || 'N√£o informado'}</div>
                    </div>
                    <div class="dado-item full-width">
                        <div class="dado-label">Observa√ß√µes</div>
                        <div class="dado-valor">${cliente.observacoes || 'Nenhuma observa√ß√£o'}</div>
                    </div>
                </div>
            `;
            
            // Estat√≠sticas
            document.getElementById('estatisticasCliente').innerHTML = `
                <div class="stat-card primary">
                    <div class="stat-icon">üõí</div>
                    <div class="stat-content">
                        <div class="stat-number">${stats.total_compras}</div>
                        <div class="stat-label">Total de Compras</div>
                    </div>
                </div>
                <div class="stat-card success">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-content">
                        <div class="stat-number">${stats.valor_total_compras_formatado}</div>
                        <div class="stat-label">Valor Total Comprado</div>
                    </div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-icon">‚è∞</div>
                    <div class="stat-content">
                        <div class="stat-number">${stats.valor_em_aberto_formatado}</div>
                        <div class="stat-label">Valor em Aberto</div>
                    </div>
                </div>
                <div class="stat-card info">
                    <div class="stat-icon">üìã</div>
                    <div class="stat-content">
                        <div class="stat-number">${stats.vendas_abertas}</div>
                        <div class="stat-label">Vendas em Aberto</div>
                    </div>
                </div>
            `;
            
            // Hist√≥rico de vendas
            const vendasHtml = data.vendas.map(venda => `
                <div class="venda-item">
                    <div class="venda-header">
                        <div class="venda-info">
                            <span class="venda-id">#${venda.id}</span>
                            <span class="venda-data">${venda.data_venda_formatada}</span>
                        </div>
                        <span class="venda-status status-${venda.status}">${venda.status_texto}</span>
                    </div>
                    <div class="venda-valores">
                        <div class="valor-info">
                            <span class="valor-label">Total:</span>
                            <span class="valor-numero">${venda.valor_total_formatado}</span>
                        </div>
                        ${venda.valor_restante > 0 ? `
                            <div class="valor-info restante">
                                <span class="valor-label">Restante:</span>
                                <span class="valor-numero">${venda.valor_restante_formatado}</span>
                            </div>
                        ` : ''}
                    </div>
                    <div class="venda-actions">
                        <button class="btn btn-secondary btn-small" onclick="verDetalhesVenda(${venda.id})">
                            <span>üëÅÔ∏è</span> Ver Detalhes
                        </button>
                        ${venda.status === 'aberta' || venda.status === 'vencida' ? 
                            `<button class="btn btn-success btn-small" onclick="processarPagamentoVenda(${venda.id})">
                                <span>üí∞</span> Pagar
                            </button>` : 
                            ''}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('historicoVendas').innerHTML = vendasHtml || 
                '<div class="empty-message">Nenhuma venda encontrada para este cliente.</div>';
        }

        // Fun√ß√µes auxiliares
        function mostrarLoadingClientes() {
            document.getElementById('loadingClientes').style.display = 'block';
            document.getElementById('listaClientes').style.display = 'none';
            document.getElementById('nenhumCliente').style.display = 'none';
        }

        function esconderLoadingClientes() {
            document.getElementById('loadingClientes').style.display = 'none';
            document.getElementById('listaClientes').style.display = 'grid';
        }

        function mostrarEstadoVazio() {
            document.getElementById('listaClientes').style.display = 'none';
            document.getElementById('nenhumCliente').style.display = 'block';
            document.getElementById('paginacaoClientes').style.display = 'none';
        }

        // Fun√ß√µes de modal
        function fecharModalCliente() {
            fecharModal('modalCliente');
        }

        function fecharModalPerfil() {
            fecharModal('modalPerfilCliente');
            clienteAtual = null;
        }

        function fecharModalConfirmacao() {
            fecharModal('modalConfirmacao');
            clienteParaExcluir = null;
        }

        // [Outras fun√ß√µes continuam...]

        // Pagina√ß√£o
        function atualizarPaginacao(totalPaginas) {
            const paginacaoElement = document.getElementById('paginacaoClientes');
            const infoElement = document.getElementById('infoPaginacao');
            const resultadosElement = document.getElementById('resultadosInfo');
            const btnAnterior = document.getElementById('btnAnterior');
            const btnProximo = document.getElementById('btnProximo');

            if (totalPaginas <= 1) {
                paginacaoElement.style.display = 'none';
                return;
            }

            paginacaoElement.style.display = 'flex';
            infoElement.textContent = `P√°gina ${paginaAtual} de ${totalPaginas}`;
            resultadosElement.textContent = `${clientesFiltrados.length} de ${clientes.length}`;
            
            btnAnterior.disabled = paginaAtual === 1;
            btnProximo.disabled = paginaAtual === totalPaginas;
        }

        function paginaAnterior() {
            if (paginaAtual > 1) {
                paginaAtual--;
                renderizarClientes();
            }
        }

        function proximaPagina() {
            const totalPaginas = Math.ceil(clientesFiltrados.length / itensPorPagina);
            if (paginaAtual < totalPaginas) {
                paginaAtual++;
                renderizarClientes();
            }
        }

        // Outras fun√ß√µes (exportar, navega√ß√£o, etc.)
        function exportarClientes() {
            window.open('/api/relatorios/clientes/exportar?formato=excel', '_blank');
        }

        function novaVendaCliente(clienteId = null) {
            const id = clienteId || (clienteAtual ? clienteAtual.id : null);
            if (id) {
                window.location.href = `/vendas?cliente_id=${id}`;
            }
        }

        function processarPagamentoCliente(clienteId = null) {
            const id = clienteId || (clienteAtual ? clienteAtual.id : null);
            if (id) {
                window.location.href = `/pagamentos?cliente_id=${id}`;
            }
        }

        function verDetalhesVenda(vendaId) {
            window.location.href = `/vendas?venda_id=${vendaId}`;
        }

        function processarPagamentoVenda(vendaId) {
            window.location.href = `/pagamentos?venda_id=${vendaId}`;
        }

        // Fun√ß√µes do perfil
        function editarClientePerfil() {
            if (clienteAtual) {
                fecharModalPerfil();
                editarCliente(clienteAtual.id);
            }
        }

        function excluirClientePerfil() {
            if (clienteAtual) {
                clienteParaExcluir = clienteAtual.id;
                document.getElementById('textoConfirmacao').textContent = 
                    `Tem certeza que deseja excluir o cliente "${clienteAtual.nome}"?`;
                abrirModal('modalConfirmacao');
            }
        }

        function confirmarExclusao() {
            if (!clienteParaExcluir) return;

            mostrarLoading('Excluindo cliente...');

            fetch(`/api/clientes/${clienteParaExcluir}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                esconderLoading();
                fecharModalConfirmacao();
                
                if (data.sucesso) {
                    mostrarNotificacao(data.mensagem || 'Cliente exclu√≠do com sucesso!', 'success');
                    if (clienteAtual && clienteAtual.id === clienteParaExcluir) {
                        fecharModalPerfil();
                    }
                    carregarClientes();
                } else {
                    mostrarNotificacao(data.erro || 'Erro ao excluir cliente', 'error');
                }
            })
            .catch(error => {
                esconderLoading();
                console.error('Erro:', error);
                mostrarNotificacao('Erro ao excluir cliente', 'error');
            });
        }

        function exportarHistoricoCliente() {
            if (clienteAtual) {
                window.open(`/api/relatorios/cliente/${clienteAtual.id}/historico?formato=excel`, '_blank');
            }
        }
    </script>

    <style>
        /* Estilos espec√≠ficos da p√°gina de clientes */
        .page-subtitle {
            color: var(--gray-500);
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .metrics-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .metric-card {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: var(--transition-normal);
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .metric-card.warning {
            border-left: 4px solid var(--warning);
        }

        .metric-card.success {
            border-left: 4px solid var(--success);
        }

        .metric-icon {
            width: 48px;
            height: 48px;
            background: var(--gray-100);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .metric-content {
            flex: 1;
        }

        .metric-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
            letter-spacing: -0.025em;
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            text-transform: uppercase;
            font-weight: 500;
            letter-spacing: 0.05em;
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .filters-header h3 {
            color: var(--gray-700);
            font-size: 1rem;
            font-weight: 600;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .cliente-card {
            transition: var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .cliente-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--success), var(--info));
            transform: scaleX(0);
            transition: var(--transition-normal);
        }

        .cliente-card:hover::before {
            transform: scaleX(1);
        }

        .cliente-info-principal {
            flex: 1;
        }

        .cliente-contato {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        .cliente-telefone,
        .cliente-email {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .cliente-detalhes {
            margin: 1rem 0;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .info-item.destaque {
            background: var(--secondary-red);
            padding: 0.5rem;
            border-radius: var(--radius-md);
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .progress-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            font-weight: 500;
        }

        .progress-percent {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .progress-fill.success {
            background: linear-gradient(90deg, var(--success), var(--success));
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, var(--warning), var(--warning-light));
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, var(--error), var(--error-light));
        }

        .btn-action {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-lg);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 0.875rem;
        }

        .btn-action.primary {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .btn-action.primary:hover {
            background: var(--primary-red);
            color: var(--white);
        }

        .btn-action.success:hover {
            background: var(--success);
            color: var(--white);
        }

        .btn-action.info:hover {
            background: var(--info);
            color: var(--white);
        }

        .btn-action.secondary:hover {
            background: var(--gray-600);
            color: var(--white);
        }

        .form-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .form-section-title {
            color: var(--gray-700);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .field-help {
            margin-top: 0.25rem;
        }

        .field-help small {
            color: var(--gray-400);
            font-size: 0.75rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .section-actions {
            display: flex;
            gap: 0.5rem;
        }

        .perfil-dados-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .dado-item {
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
        }

        .dado-item.full-width {
            grid-column: 1 / -1;
        }

        .dado-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .dado-valor {
            font-weight: 500;
            color: var(--gray-900);
        }

        .dado-valor.destaque {
            color: var(--primary-red);
            font-weight: 600;
        }

        .dado-valor.positivo {
            color: var(--success);
        }

        .dado-valor.negativo {
            color: var(--error);
        }

        .stat-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 1rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .stat-card.primary {
            border-left: 4px solid var(--primary-red);
        }

        .stat-card.success {
            border-left: 4px solid var(--success);
        }

        .stat-card.warning {
            border-left: 4px solid var(--warning);
        }

        .stat-card.info {
            border-left: 4px solid var(--info);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            background: var(--gray-100);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .stat-number {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
            letter-spacing: -0.025em;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            font-weight: 500;
        }

        .venda-item {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .venda-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .venda-info {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .venda-id {
            font-weight: 600;
            color: var(--primary-red);
        }

        .venda-data {
            color: var(--gray-500);
            font-size: 0.875rem;
        }

        .venda-valores {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .valor-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .valor-info.restante {
            color: var(--error);
            font-weight: 600;
        }

        .valor-label {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .valor-numero {
            font-weight: 500;
            color: var(--gray-900);
        }

        .venda-actions {
            display: flex;
            gap: 0.5rem;
        }

        .empty-message {
            text-align: center;
            color: var(--gray-500);
            font-style: italic;
            padding: 2rem;
        }

        .confirmation-content {
            text-align: center;
        }

        .confirmation-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .warning-box {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: var(--radius-md);
            padding: 0.75rem;
            margin-top: 1rem;
            font-size: 0.875rem;
            color: #92400e;
        }

        .pagination-details {
            font-size: 0.75rem;
            color: var(--gray-400);
            margin-left: 0.5rem;
        }

        @media (max-width: 768px) {
            .perfil-dados-grid {
                grid-template-columns: 1fr;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .metrics-summary {
                grid-template-columns: repeat(2, 1fr);
            }

            .filter-options {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
        }
    </style>
</body>
</html>